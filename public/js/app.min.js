function sizeBySeverity(){NV.treemap.set("sizeOption","cvss")}function sizeByCriticality(){NV.treemap.set("sizeOption","criticality")}function sizeByCount(){NV.treemap.set("sizeOption","value")}function colorBySeverity(){NV.treemap.set("colorOption","cvss")}function colorByCriticality(){NV.treemap.set("colorOption","criticality")}function colorByCount(){NV.treemap.set("colorOption","count")}function setNBEData(a){NV.nessus.setData(a)}function handleGroupAdd(){var a=$("#ipStart").val(),b=$("#ipEnd").val(),c=$("#groupName").val(),d=$("#defaultWeight").val(),e={start:a,end:b,groupName:c,weight:d};groupList.push(e),NV.nessus.trigger("change:groups"),d3.select("#coloroptions").selectAll("button").attr("disabled",null),d3.select("#sizeoptions").selectAll("button").attr("disabled",null),d3.select("#coloroptions").selectAll("button").attr("title",null),d3.select("#sizeoptions").selectAll("button").attr("title",null),updateCurrentGroupTable()}function clearData(){eventList={},groupList=[],$("#file-list").html(""),$("#file-reset-btn").addClass("disabled"),$("#file-continue-btn").addClass("disabled"),$("#groups-continue-btn").addClass("disabled"),$("#groupsTabNav").addClass("disabled"),$("#visTabNav").addClass("disabled")}function dataTabActive(){$("#file-status-msg").html(""),$("#file-status").alert("close")}function dataLoaded(a){$("#groupsTabNav").removeClass("disabled"),$("#visTabNav").removeClass("disabled"),$("#file-status").css("display","block"),$("#file-status").addClass("alert-success"),$("#file-status-msg").html('<i class="icon-file"></i> <strong>'+a+"</strong> loaded in browser."),$("#file-list").append(' <i class="icon-file"></i> '+a),$("#file-reset-btn").removeClass("disabled"),$("#file-continue-btn").removeClass("disabled")}function groupsTabActive(){eventList||updateEventList(),updateCurrentGroupTable(),$("#visTabNav").removeClass("disabled"),$("#groups-continue-btn").removeClass("disabled")}function visTabActive(){eventList||(updateEventList(),updateCurrentGroupTable()),$("#helpIcon").tipsy("show"),setTimeout(function(){$("#helpIcon").tipsy("hide")},2500),NV.resize()}function updateEventList(){var a="",b="";a=parseNBEFile(nbeText1),eventList=a,""!==nbeText2.trim()&&(NV.nessus.set("isChangeVis",!0),b=parseNBEFile(nbeText2),eventList=mergeNBEs(a,b))}function updateCurrentGroupTable(){eventList||(console.log("updateCurrentGroupTable needed to update eventList: this is unexpected."),updateEventList());var a=findIPsInList(eventList);groups={};for(var b=0;b<a.length;b++){for(var c=findGroupName(a[b]),d=1,e=0;e<groupList.length;e++)groupList[e].groupName===c&&(d=groupList[e].weight);var f={ip:a[b],weight:d};groups[c]||(groups[c]=[]),groups[c].push(f)}buildTable(groups),eventList=addGroupInfoToData(groups,eventList),setNBEData(eventList)}function mergeNBEs(a,b){function c(a,b){return a.ip===b.ip&&a.vulnid===b.vulnid&&a.vulntype===b.vulntype&&a.cvss===b.cvss&&a.port===b.port?!0:!1}var d,e,f,g,h=[],i=0,j=0;for(e=0;e<a.length;e++){for(d=!1,f=0;f<b.length;f++)if(c(a[e],b[f])){d=!0,g=a[e],g.state="open",h.push(g),b.splice(f,1),i+=1;break}d===!1&&(g=a[e],g.state="fixed",h.push(g),j+=1)}for(console.log("open items: "+i),console.log("changed items: "+j),console.log("new items: "+b.length);b.length>0;)g=b.pop(),g.state="new",h.push(g);return h}function findIPsInList(a){for(var b={},c=0;c<a.length;c++)b[a[c].ip]=!0;return b=Object.keys(b)}function findGroupName(a){function b(a,b){for(var c=0;4>c;c++)if(parseInt(a[c],10)>parseInt(b[c],10))return!1;return!0}function c(a,c){return b(c,a)}var d=a.split(".");if(4!==d.length)throw"address of "+groupList[e].end+" is invalid";for(var e=0;e<groupList.length;e++){var f=groupList[e].start.split(".");if(4!==f.length)throw"start address of "+groupList[e].start+" is invalid";var g=groupList[e].end.split(".");if(4!==g.length)throw"end address of "+groupList[e].end+" is invalid";if(b(f,d)&&c(g,d))return groupList[e].groupName}return"none"}function addGroupInfoToData(a,b){var c,d,e=[],f={},g=Object.keys(a);for(d=0;d<g.length;d++){var h=a[g[d]];for(c=0;c<h.length;c++)f[h[c].ip]={group:g[d],weight:h[c].weight}}for(c=0;c<b.length;c++)e.push(b[c]),e[c].group=f[b[c].ip].group,e[c].criticality=parseInt(f[b[c].ip].weight,10);return e}function buildTable(a){$("#currentGroupTable").select("tbody").html("");for(var b,c,d=Object.keys(a),e=0;e<d.length;e++)for(var f=a[d[e]],g=0;g<f.length;g++)b='<select class="weightSelect" id="weightSelect'+f[g].ip.split(".").join("_")+'"',b+='><option value="1">1 (lowest)</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10 (highest)</option></select>',c="<tr>",c+="<td>"+d[e]+"</td><td>"+f[g].ip+"</td>",c+="<td>"+b+"</td>",c+="</tr>",$("#currentGroupTable").select("tbody").append(c),$("#weightSelect"+f[g].ip.split(".").join("_")).children().eq(f[g].weight-1).attr("selected","selected")}!function(){"use strict";return $(window).resize(function(){NV.resize()}),$(function(){NV.start({pushState:!0})}),{}}(),d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})},d3.stringWidth=function(a,b,c,d){var e=c||"12px arial",f=a.append("text").attr("class",d).style("font",e).style("opacity",0).style("visibility","hidden").style("display","inline").text(b),g=f.node().getComputedTextLength();return d3.select(f).remove(),g};var ColorLegend=Backbone.Model.extend({initialize:function(){this.makeScales(10);var a=["fixed","open","new"],b=["severity"];this.set("activeColors",b),this.get("datasource").on("change:isChangeVis",function(){var c=this.get("datasource").get("isChangeVis");c?this.set("activeColors",a):this.set("activeColors",b)},this)},makeScales:function(a){var b=["#F1EEF6","#E5E7FF","#DFE0F7","#CAD5ED","#A6BDDB","#74A9CF","#3690C0","#0570B0","#045A8D","#3578A0"],c=d3.hsl("#F1EEF6"),d=(d3.hsl("#2B8CBE"),d3.hsl("#405E50")),e=d3.hsl("#AD009F"),f=d3.hsl("#FFCF40"),g=d3.scale.quantize().domain([0,a]).range(b),h=d3.scale.linear().domain([0,a]).range([c,d]).clamp(!0),i=d3.scale.linear().domain([0,a]).range([c,f]).clamp(!0),j=d3.scale.linear().domain([0,a]).range([c,e]).clamp(!0);this.set("severity",g),this.set("fixed",h),this.set("open",i),this.set("new",j)}}),Hierarchy=Backbone.Model.extend({initialize:function(){var a=[{target:"nv"},{useData:!0,target:"ip"},{prefix:":",useData:!0,target:"port"},{prefix:"id",useData:!0,target:"vulnid"}];this.set({data:a,silent:!0}),this.get("datasource").on("change:isChangeVis",function(){var a=this.get("datasource").get("isChangeVis"),b=this.get("data");a?b.push({useData:!0,target:"state"}):b=_.filter(b,function(a){return"state"!==a.target}),this.set("data",b),this.trigger("change:data")},this),this.get("datasource").on("change:groups",function(){var a=this.get("data"),b=_.find(a,function(a){return"group"===a.target});b||a.splice(1,0,{useData:!0,target:"group"}),this.set("data",a),this.trigger("change:data")},this),this.get("app").on("hierarchyChange",function(a){this.set("data",a)},this)}}),Histogram=Backbone.Model.extend({initialize:function(){this.on("change:limit",this.updateData,this),this.get("datasource").on("dataset updated",this.updateData,this)},updateData:function(){var a=this.get("filterOptions"),b=a.attribute,c=this.get("bins")||"",d=this.get("range")||"",e=this.get("datamap")||"",f=this.get("datasource").getData(a),g=d3.layout.histogram().value(function(a){return e?e(a[b]):a[b]});c&&g.bins(c),d&&g.range(d);var h=g(f);this.get("limit")&&(h=_.sortBy(h,function(a){return a.length}).reverse(),h.length>this.get("limit")&&(h=_.first(h,this.get("limit"))));var i;i=c?h.map(function(a,b){return e?e.domain()[b]:b+1}):h.map(function(a){return a[0]?a[0][b]:void 0}),this.set("data",h.map(function(a,b){return{length:a.length,label:i[b]}}))}}),Nessus=Backbone.Model.extend({initialize:function(){this.logs=crossfilter();var a=this;$.each(this.get("dimensions"),function(b,c){a["by"+c]=a.logs.dimension(function(a){return a[c]})}),this.isChangeVis=!1},getData:function(a){var b=a||{},c=b.limit||1/0;b.useGlobalFilters?this.activateFilters(this.get("filters")):this.clearFilters(),b.filters&&b.filters.length>0&&this.activateFilters(b.filters);var d=this["by"+b.attribute].top(c);return this.clearFilters(),d},setData:function(a){this.logs.size()>1&&(this.logs=crossfilter()),this.logs.add(a),this.trigger("dataset updated")},updateFilter:function(a){var b=a.split(";"),c=b.map(function(a){return a.split(",")}),d=c.map(function(a){return{attribute:a[0],rangeMin:a[1],rangeMax:a[2]}});this.set("filters",d),this.trigger("filterChange",d)},activateFilters:function(a){var b=a||[];if(!(b.length<1)){var c=this;$.each(b,function(a,b){b.exact?c["by"+b.attribute].filter(b.exact):c["by"+b.attribute].filter([b.rangeMin,b.rangeMax])})}},clearFilters:function(){var a=this;$.each(this.get("dimensions"),function(b,c){a["by"+c].filterAll()})}}),NessusInfo=Backbone.Model.extend({initialize:function(){var a=this;this.get("app").on("treemap_mouseover",function(a){-1!==a.indexOf("id")&&(a=a.replace("id",""),this.updateData(a))},this),this.get("app").on("histogramMouseover",function(a){(-1!==a.chart.indexOf("notes")||-1!==a.chart.indexOf("holes"))&&this.updateData(a.label)},this),$.get("data/vulnIDs.json",function(b){a.set("vulnIdInfo",b)})},updateData:function(a){var b=this.get("vulnIdInfo")[a];b.vulnid=a,this.set("data",b)}}),Treemap=Backbone.Model.extend({initialize:function(){this.set("sizeOption","cvss"),this.set("colorOption","cvss"),this.get("datasource").on("dataset updated",this.updateData,this),this.on("change:sizeOption",this.updateData,this),this.on("change:colorOption",this.updateData,this),this.on("change:filterOptions",this.updateData,this),this.get("hierarchy").on("change",this.updateData,this),this.get("app").on("histogramClick",function(a){"off"===a.state?b("remove"):"cvss"===a.chart?(a.label=a.label-1,b("cvss",a.label+0,a.label+1.01)):"vuln type"===a.chart?b("vulntype",a.label):"top holes"===a.chart?b("vulnid",a.label):"top notes"===a.chart&&b("vulnid",a.label)});var a=this,b=function(b,c,d){var e=a.get("filterOptions");"remove"===b?e.filters=null:d?e.filters=[{attribute:b,rangeMin:c,rangeMax:d}]:e.filters=[{attribute:b,exact:c}],a.set("filterOptions",e),a.updateData()}},updateData:function(){function a(a){var b=d3.nest();return _.each(a,function(a){b.key(function(b){return a.useData?a.prefix?a.prefix+b[a.target]:b[a.target]:a.target})}),b.sortKeys(d3.ascending),b.entries(d)}var b=this.get("filterOptions"),c=(b.attribute,this.get("hierarchy").get("data")),d=this.get("datasource").getData(b);if(d.length<1)return void console.log("current filter yields no data, try another");var e=a(c);e=e[0],this.accumulate(e),this.set("data",e)},accumulate:function(a){function b(a){return a.values?a.count=a.values.reduce(function(a,c){return a+b(c)},0):a.value}function c(a){return a.values?a.cvss=a.values.reduce(function(a,b){return Math.max(a,c(b))},0):a.cvss}function d(a){return a.values?a.criticality=a.values.reduce(function(a,b){return Math.max(a,d(b))},0):a.criticality}function e(a){return a.values?a.state=a.values.reduce(function(a,b){return e(b)},0):a.state}function f(a){return a.values?a.fixedCount=a.values.reduce(function(a,b){return a+f(b)},0):"fixed"===a.state?1:0}function g(a){return a.values?a.openCount=a.values.reduce(function(a,b){return a+g(b)},0):"open"===a.state?1:0}function h(a){return a.values?a.newCount=a.values.reduce(function(a,b){return a+h(b)},0):"new"===a.state?1:0}var i=this;return a.cvss=c(a),a.count=b(a),a.criticality=d(a),this.get("datasource").get("isChangeVis")&&(a.state=e(a),a.fixedCount=f(a),a.openCount=g(a),a.newCount=h(a)),a.values?a.value=a.values.reduce(function(a,b){return a+i.accumulate(b)},0):a[this.get("sizeOption")]}}),ColorLegendView=Backbone.View.extend({initialize:function(){this.model.on("change",this.render,this),this.render()},render:function(){var a=150,b=30,c=26,d=15,e=this.model.get("activeColors"),f=d3.select(this.options.target),g=this,h=f.selectAll(".legendEntry").data(e,function(a){return a}),i=h.enter().append("div").classed("legendEntry",!0).append("svg").attr("width",a).attr("height",b);i.selectAll("rect").data(d3.range(1,10)).enter().append("rect").attr("width",d).attr("height",d).attr("x",function(a,b){return b*d}).style("fill",function(a,b){var c=d3.select(this.parentNode).datum(),d=g.model.get(c);return d(b)}).style("stroke",function(a,b){var c=d3.select(this.parentNode).datum(),d=g.model.get(c);return d(b)}),i.append("text").attr("x",a/2).attr("y",c).attr("text-anchor","middle").text(function(a){return a}),i.append("text").attr("x",0).attr("y",c).attr("text-anchor","start").classed("legend_min",!0),i.append("text").attr("x",a-d).attr("y",c).attr("text-anchor","end").classed("legend_max",!0),h.select(".legend_min").text(function(a){return g.model.get(a).domain()[0]}),h.select(".legend_max").text(function(a){return g.model.get(a).domain()[1]}),h.exit().remove()}}),HierarchyView=Backbone.View.extend({initialize:function(){d3.select(this.options.target).append("ul");this.model.on("change:data",this.render,this),this.render()},render:function(){var a=d3.select(this.options.target).select("ul"),b=this.model.get("data"),c=this;a.selectAll("li").remove();var d=a.selectAll("li").data(b,function(a){return a.target});d.enter().append("li").attr("class",function(a){return"nv"===a.target?"hierarchyNode ui-state-disabled":"hierarchyNode"}).text(function(a){return a.target}).append("i").attr("class",function(a){return"nv"!==a.target?"icon-resize-horizontal":void 0}),d.exit().remove(),$("#hierarchy ul").sortable({items:"li:not(.ui-state-disabled)",cursor:"move",stop:function(a,b){var d=[];$("#hierarchy li").each(function(a,b){d.push(d3.select(b).datum())}),c.options.app.trigger("hierarchyChange",d)}})}}),HistogramView=Backbone.View.extend({initialize:function(){this.margin=40,this.model.on("change:data",this.render,this),this.options.app.on("resize",this.render,this),d3.select(this.options.target).style("float","left").style("margin-right",this.margin+"px"),d3.select(this.options.target).append("svg").attr("height",this.options.h)},render:function(){var a,b,c=d3.select(this.options.target).select("svg"),d=(this.model.get("app"),this.model.get("data")),e=(this.options.range,this.model.get("attribute"),this.options.h),f=this.options.barwidth,g=2,h=this.options.title,i=this.options.target,j=this,k=d.length,l=c.selectAll(".bar"),m=c.selectAll(".histogramlabel"),n=c.selectAll(".histogramtitle");$(document).innerWidth();if("#topHoleHistogram"===i||"#topNoteHistogram"===i){var o=$("#filters").width(),p=$("#cvssHistogram").width(),q=$("#vulnTypeHistogram").width(),r=this.margin;this.model.get("limit")||"";openSpace=o-p-q-2*r,b=openSpace/2-1.2*r;var s=Math.floor(b/(f+g));this.model.set("limit",s),d=this.model.get("data"),k=d.length,a=(f+g)*k}else b=a=(f+g)*k;c.attr("width",a),$(i).width(b);var t=d3.scale.linear().domain([0,d3.max(d,function(a){return a.length})]).range([1,e-40]),u=l.data(d,function(a){return a.length});u.enter().append("rect").classed("bar inactive",!0).on("click",function(){w(this)}).on("mouseover",function(){v(this)}).attr("width",f).attr("height",function(a,b){return t(a.length)}).attr("x",function(a,b){return b*(f+g)}).attr("y",function(a,b){return e-45-t(a.length)}),u.exit().remove(),labelSel=m.data(d,function(a){return a.label}),labelSel.enter().append("text").attr("class","histogramlabel").attr("x",function(a,b){return b*(f+g)+f/2}).attr("y",e-35).attr("text-anchor","middle").text(function(a){return a.label}),labelSel.exit().remove(),titleSel=n.data([h],function(a){return a}),titleSel.enter().append("text").attr("class","histogramtitle").attr("text-anchor","middle").text(h),titleSel.attr("x",a/2).attr("y",e-20),titleSel.exit().remove();var v=function(a){var b={chart:h,label:d3.select(a).data()[0].label};j.options.app.trigger("histogramMouseover",b)},w=function(a){var b=d3.select(a),c=b.classed("active"),d=d3.select(a).data()[0],e={label:d.label,length:d.length,chart:j.options.title};d3.selectAll(".bar").classed("active",!1),d3.selectAll(".bar").classed("inactive",!0),c?e.state="off":(b.classed("active",!0),b.classed("inactive",!1),e.state="on"),j.options.app.trigger("histogramClick",e)}}}),NessusInfoView=Backbone.View.extend({initialize:function(){this.model.on("change:data",this.render,this);var a=$(this.options.target);a.html("<hr><p>"),a.append("Nessus Info View<br /><br />"),a.append("ID: <br />"),a.append("Title: <br />"),a.append("Family: <br />"),a.append("Synopsis: <br />"),a.append("Description: <br />"),a.append("UpdateInfo: <br />"),a.append("Solution: <br />"),a.append("</p>")},render:function(){var a=this.model.get("data"),b=$(this.options.target);b.html("<hr><p>"),b.append("ID: "+a.vulnid+"<br />"),b.append("Title: "+a.title+"<br />"),a.family&&""!==a.family&&b.append("Family: "+a.family+"<br />"),a.otherInfoList.length>0&&b.append(a.otherInfoList[0]+"<br />"),b.append("<br />"),a.synopsis&&""!==a.synopsis&&b.append("Synopsis: "+a.synopsis+"<br /><br />"),a.description&&""!==a.description&&b.append("Description: "+a.description+"<br /><br />"),a.updateInfo&&""!==a.updateInfo&&b.append("UpdateInfo: "+a.updateInfo+"<br /><br />"),a.solution&&""!==a.solution&&b.append("Solution: "+a.solution),b.append("</p>")}}),TreemapView=Backbone.View.extend({initialize:function(){this.model.on("change:data",this.render,this),this.options.app.on("hierarchyChange",this.render,this),this.options.app.on("resize",this.resize,this),this.margin={top:20,right:20,bottom:0,left:0},this.width=960,this.height=500-this.margin.top-this.margin.bottom,this.formatNumber=d3.format(",d"),this.transitioning=!1,this.x=d3.scale.linear(),this.y=d3.scale.linear(),this.treemap=d3.layout.treemap(),this.svg=d3.select("#vis").append("svg").append("g"),this.grandparent=this.svg.append("g").attr("class","grandparent"),this.grandparent.append("rect"),this.grandparent.append("text")},render:function(){function a(a){a.x=a.y=0,a.dx=k.width,a.dy=k.height,a.depth=0}function b(a){a.values&&(k.treemap.nodes({values:a.values}),a.values.forEach(function(c){c.x=a.x+c.x*a.dx,c.y=a.y+c.y*a.dy,c.dx*=a.dx,c.dy*=a.dy,c.parent=a,b(c)}))}function c(a){function b(a){if(!k.transitioning&&a){k.transitioning=!0;var b=c(a),d=l.transition().duration(1250),e=b.transition().duration(1250);k.x.domain([a.x,a.x+a.dx]),k.y.domain([a.y,a.y+a.dy]),k.svg.style("shape-rendering",null),k.svg.selectAll(".depth").sort(function(a,b){return a.depth-b.depth}),b.selectAll("text").style("fill-opacity",0),d.selectAll("text").call(g).style("fill-opacity",0),e.selectAll("text").call(g).style("fill-opacity",1),d.selectAll("rect").call(h),e.selectAll("rect").call(h),d.remove().each("end",function(){k.svg.style("shape-rendering","crispEdges"),k.transitioning=!1,f()})}}var j=a;k.grandparent.datum(a.parent).on("click",b).select("text").text(i(a));var l=k.svg.insert("g",".grandparent").datum(a).attr("class","depth"),m=l.selectAll("g").data(a.values).enter().append("g");return m.filter(function(a){return a.values}).classed("children",!0).attr("id",function(a){return"IP"+a.key.replace(/\./g,"")}).on("click",function(a){d(a)||b(a)}).on("mouseover",function(a){k.options.app.trigger("treemap_mouseover",a.key),d3.select(this).moveToFront(),d3.select(this).select(".parent").style("stroke","black").style("stroke-width","2px")}).on("mouseout",function(a){d3.select(this).select(".parent").style("stroke","").style("stroke-width",""),d3.select(this).select("text").style("font-weight","normal")}),m.selectAll(".child").data(function(a){return a.values||[a]}).enter().append("rect").attr("class","child").style("fill",function(a){var b=k.model.get("colorOption"),c="severity",d=k.options.color.get(c);if(a.state){var f=e([a.fixedCount,a.newCount,a.openCount]);a.state=0===f?"fixed":1===f?"new":"open","new"===a.state&&(d=k.options.color.get("new")),"open"===a.state&&(d=k.options.color.get("open")),"fixed"===a.state&&(d=k.options.color.get("fixed"))}return"count"===b?k.options.color.makeScales(j.values.length):k.options.color.makeScales(10),d(a[b])}).call(h),m.append("rect").attr("class","parent").call(h).text(function(a){return k.formatNumber(a.value)}).append("title").text(function(a){return a.key}),$(".parent").tipsy({fade:!0,delayIn:777,gravity:$.fn.tipsy.autoNS,html:!0,title:function(){var a=this.__data__;return a.key+"<br /> max cvss: "+a.cvss+"<br /> vuln count: "+a.count}}),m.append("text").attr("dy",".75em").attr("text-anchor","left").text(function(a){return a.key}).classed("rectlabel",!0).call(g),f(),m}function d(a){return a.values&&1===a.values.length&&a.values[0].vulnid?!0:!1}function e(a){for(var b=-1,c=Number.MIN_VALUE,d=0;d<a.length;d++)a[d]>c&&(c=a[d],b=d);return b}function f(){d3.selectAll(".rectlabel").transition().text(function(a){var b=d3.select(this.parentNode).select(".parent").attr("width"),c=d3.stringWidth(d3.select(this.parentNode),a.key,null,"rectlabel");return b>c?a.key:"..."})}function g(a){a.attr("x",function(a){return k.x(a.x)+6}).attr("y",function(a){return k.y(a.y)+6})}function h(a){a.attr("x",function(a){return k.x(a.x)}).attr("y",function(a){return k.y(a.y)}).attr("width",function(a){return k.x(a.x+a.dx)-k.x(a.x)}).attr("height",function(a){return k.y(a.y+a.dy)-k.y(a.y)})}function i(a){return a.parent?i(a.parent)+"_"+a.key:a.key}var j=this.model.get("data"),k=this;d3.selectAll(".depth").remove(),this.width=$("#vis").width(),k.x.domain([0,k.width]).range([0,k.width]),k.y.domain([0,k.height]).range([0,k.height]),k.treemap.children(function(a,b){return b?null:a.values}).sort(function(a,b){return a.value-b.value}).ratio(k.height/k.width*.5*(1+Math.sqrt(5))).round(!1),d3.select("#vis svg").attr("width",k.width+k.margin.left+k.margin.right).attr("height",k.height+k.margin.bottom+k.margin.top).style("margin-left",-k.margin.left+"px").style("margin-right",-k.margin.right+"px"),d3.select("#vis svg g").attr("transform","translate("+k.margin.left+","+k.margin.top+")"),d3.select("#vis svg .grandparent rect").attr("y",-this.margin.top).attr("width",this.width).attr("height",this.margin.top),d3.select("#vis svg .grandparent text").attr("x",6).attr("y",6-this.margin.top).attr("dy",".75em"),a(j),b(j),c(j)},resize:function(){this.width=$("#vis").width(),this.x.domain([0,this.width]).range([0,this.width]),d3.select("#vis > svg").attr("width",this.width+this.margin.left+this.margin.right),d3.selectAll(".grandparent rect").attr("width",this.width),this.treemap.ratio(this.height/this.width*.5*(1+Math.sqrt(5))),this.render()}}),NV=new(Backbone.Router.extend({routes:{"":"index"},initialize:function(){this.nessus=new Nessus({dimensions:["ip","port","cvss","vulnid","vulntype"]}),this.cvssHistogram=new Histogram({app:this,datasource:this.nessus,bins:10,range:[0,10],filterOptions:{attribute:"cvss"}}),this.cvssHistogramView=new HistogramView({app:this,model:this.cvssHistogram,target:"#cvssHistogram",barwidth:20,w:220,h:165,title:"cvss"});var a=d3.scale.ordinal().domain(["hole","port","note"]).range([1,2,3]);this.vulnTypeHistogram=new Histogram({app:this,datasource:this.nessus,bins:3,datamap:a,filterOptions:{attribute:"vulntype"}}),this.vulnTypeHistogramView=new HistogramView({app:this,model:this.vulnTypeHistogram,target:"#vulnTypeHistogram",barwidth:20,w:66,h:165,title:"vuln type"}),this.topNoteHistogram=new Histogram({app:this,datasource:this.nessus,limit:6,filterOptions:{attribute:"vulnid",filters:[{attribute:"vulntype",exact:"note"}]}}),this.topNoteHistogramView=new HistogramView({app:this,model:this.topNoteHistogram,target:"#topNoteHistogram",barwidth:30,w:180,h:165,title:"top notes"}),this.topHoleHistogram=new Histogram({app:this,datasource:this.nessus,limit:6,filterOptions:{attribute:"vulnid",filters:[{attribute:"vulntype",exact:"hole"}]}}),this.topHoleHistogramView=new HistogramView({app:this,barwidth:30,model:this.topHoleHistogram,target:"#topHoleHistogram",w:180,h:165,title:"top holes"}),this.hierarchy=new Hierarchy({app:this,datasource:this.nessus}),this.hierarchyView=new HierarchyView({app:this,model:this.hierarchy,target:"#hierarchy"}),this.colorLegend=new ColorLegend({app:this,datasource:this.nessus}),this.colorLegendView=new ColorLegendView({app:this,model:this.colorLegend,target:"#colorlegend"}),this.treemap=new Treemap({app:this,datasource:this.nessus,hierarchy:this.hierarchy,filterOptions:{attribute:"vulnid"}}),this.treemapView=new TreemapView({app:this,model:this.treemap,color:this.colorLegend,target:"#vis"}),this.nessusInfo=new NessusInfo({app:this,datasource:this.nessus}),this.nessusInfoView=new NessusInfoView({app:this,model:this.nessusInfo,target:"#nessusinfo"})},start:function(){Backbone.history.start()},resize:function(){this.trigger("resize")}})),eventList,nbeText1="",nbeText2="",groupList=[],handleFileSelect=function(a){var b=document.getElementById(a);"undefined"==typeof window.FileReader?($("#file-status").css("display","block"),$("#file-status").addClass("alert-error"),console.log("FileReader not supported")):console.log("FileReader supported"),b.ondragover=function(){return this.className="hover",!1},b.ondragend=function(){return this.className="",!1},b.ondrop=function(a){this.className="",a.preventDefault();var c=a.dataTransfer.files,d=c[0];return b.loadFile(d),!1},b.loadFile=function(a){console.log("called loadFile");var b=new FileReader;return b.readAsText(a),b.onload=function(b){""===nbeText1.trim()?nbeText1=b.target.result:nbeText2=b.target.result,console.log("Loaded file: "+a.name),dataLoaded(a.name)},b.onerror=function(){$("#file-status").css("display","block"),$("#file-status").addClass("alert-error"),$("#file-status-msg").html("could not parse file "+a.name+" as text")},!1}};$("#sampleDataLink").click(function(){var a="data/testNetworkOpen.nbe";$.get(a,function(b){nbeText1=b,dataLoaded("Sample file: "+a)})}),$().ready(function(){$(".hierarchyHelp").tipsy({trigger:"manual",fade:!0,gravity:"w",offset:-60}),$(".treemapHelp").tipsy({trigger:"manual",fade:!0,gravity:"s",offset:-250}),$(".nessusHelp").tipsy({trigger:"manual",fade:!0,gravity:"e"}),$(".filterHelp").tipsy({trigger:"manual",fade:!0,gravity:"s"}),$("#helpIcon").tipsy({trigger:"manual",fade:!0,gravity:"e"}),$("#helpIcon").on("mouseover",function(){$(".help").tipsy("show")}),$("#helpIcon").on("mouseout",function(){$(".help").tipsy("hide")}),handleFileSelect("file-drop"),$("#file-reset-btn").click(function(a){window.location.reload()}),$("#dataTab1Link").click(function(a){a.preventDefault(),dataTabActive()}),$("#file-continue-btn").click(function(a){$("#groupsTabLink").tab("show"),groupsTabActive()}),$("#groupsTabLink").click(function(a){a.preventDefault(),groupsTabActive()}),$("#addGroupBtn").click(function(a){handleGroupAdd()}),$("#visTabLink").on("show",function(){setTimeout(function(){visTabActive()},100)}),$("#groups-continue-btn").click(function(a){$("#visTabLink").tab("show")}),$("#visTabLink").click(function(a){a.preventDefault()})});var parseNessusResult=function(a){var b=/CVSS Base Score : (\d+\.\d+)/,c=/\D+ \((\d{1,7})\D+\)/,d=a.split("|"),e=d[2],f=parseFloat(d[4]),g=d[5];if(b.test(a))var h=parseFloat(b.exec(a)[1]);else var h=1;if(c.test(a))var i=parseFloat(c.exec(a)[1]);else var i="notes";return{ip:void 0===e?"":e,vulnid:isNaN(f)?0:f,vulntype:void 0===g?"":-1!==g.indexOf("Note")?"note":"hole",cvss:h,value:1,port:i}},parseNessusTimeStamp=function(a){var b=require("moment"),c="ddd MMM DD HH:mm:ss YYYY",d=a.split("|"),e=b(d[d.length-2],c);return e.valueOf()},hasTime=function(a){var b=a.split("|");return b[b.length-2].length>0&&"timestamps"==b[0]},isResult=function(a){return"results"===a.split("|")[0]},parseNBEFile=function(a){for(var b=a.split("\n"),c=new Array(2),d=0;d<b.length;d++)isResult(b[d])&&c.push(parseNessusResult(b[d]));return c.filter(function(){return!0})};